name: Auto Release

on:
  push:
    branches:
      - main
    paths:
      - 'static/**'
      - 'dynamic/**'

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 确保有权限创建 Release
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史以访问所有标签

    - name: Setup environment
      id: setup
      env:
        GH_TOKEN: ${{ github.token }}  # 添加认证 Token
      run: |
        RELEASE_DATE=$(TZ=Asia/Shanghai date +%Y%m%d)
        # 获取所有符合条件的标签数量
        RELEASES=$(gh api --paginate repos/${{ github.repository }}/releases --jq --arg date "$RELEASE_DATE" '.[] | select(.tag_name | startswith("v\($date)-post")) | .tag_name' | wc -l)
        POST_NUMBER=$((RELEASES + 1))
        TAG_NAME="v$RELEASE_DATE-post$POST_NUMBER"
        echo "TAG_NAME=$TAG_NAME" >> $GITHUB_ENV
        echo "DETAIL_TAG=$TAG_NAME-detail" >> $GITHUB_ENV

    - name: Get changed files
      id: changes
      run: |
        if [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
          COMMIT_RANGE="HEAD^"
        else
          COMMIT_RANGE="${{ github.event.before }}..${{ github.sha }}"
        fi

        ADDED=$(git diff --diff-filter=A --name-only $COMMIT_RANGE -- 'static/**' 'dynamic/**' --no-renames)
        MODIFIED=$(git diff --diff-filter=M --name-only $COMMIT_RANGE -- 'static/**' 'dynamic/**' --no-renames)

        # 使用 EOF 保留换行符
        echo "ADDED<<EOF" >> $GITHUB_ENV
        echo "$ADDED" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

        echo "MODIFIED<<EOF" >> $GITHUB_ENV
        echo "$MODIFIED" >> $GITHUB_ENV
        echo "EOF" >> $GITHUB_ENV

    # 后续步骤保持不变...
    - name: Generate release body
      id: generate-body
      run: |
        # ...原有生成逻辑...

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.TAG_NAME }}
        name: ${{ env.TAG_NAME }}
        body: ${{ env.BODY }}

    - name: Create Detail Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.DETAIL_TAG }}
        name: ${{ env.DETAIL_TAG }}
        body: ${{ env.DETAIL_BODY }}